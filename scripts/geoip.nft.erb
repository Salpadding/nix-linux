
flush ruleset

define dns_port          = 53
define dns_redirect_port = 53
define redir_port        = 7892
define tproxy_port       = 7894
define fakeip_range_v4   = 198.18.0.0/16
define wan_ifname        = "wan"
define mihomo_uid        = <%= ENV["MIHOMO_UID"] %>
define fwmark            = $mihomo_uid
define dnsmasq_uid       = 995
define priority_pre_mangle = -160
define docker_network    = 172.16.0.0/12

table inet nix_filter {
  chain input {
    type filter hook input priority filter;
    policy accept;
  }

  chain forward {
    type filter hook forward priority filter;
    policy accept;
  }

  chain output {
    type filter hook output priority filter;
    policy accept;
  }
}

table inet nix_nat {
  chain prerouting {
    type nat hook prerouting priority dstnat;
    policy accept;

    # hijack dns 
    iifname != "lo"  udp dport $dns_port redirect to :$dns_redirect_port
    iifname != "lo"  tcp dport $dns_port redirect to :$dns_redirect_port
  }
  

  chain postrouting {
    type nat hook postrouting priority srcnat;
    policy accept;

    oifname $wan_ifname masquerade
  }

  chain input {
    type nat hook input priority filter;
    policy accept;
  }

  chain output {
    type nat hook output priority filter;
    policy accept;
  }
}

table inet mihomo_tp {

  set lan_cidrs {
    type ipv4_addr
    flags interval
    elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 }
  }
  set cn_cidrs {
      type ipv4_addr
      flags interval
      elements = { 
        <%= cn_cidr_list.join(",\n        ") %> 
      }
  }

  set local_bypass {
    type ipv4_addr
    flags interval
    elements = { 127.0.0.0/8, 169.254.0.0/16, 224.0.0.0/4, 255.255.255.255/32 }
  }

  chain redir_container {
    type nat hook prerouting priority dstnat; 
    policy accept;

    ip daddr @lan_cidrs return
    ip daddr @local_bypass return
    ip daddr @cn_cidrs return

    ip saddr $docker_network ip daddr $fakeip_range_v4 meta l4proto { tcp, udp } redirect to :$redir_port
  }

  chain prerouting {
    type filter hook prerouting priority mangle; 
    policy accept;

    udp dport $dns_port return
    tcp dport $dns_port return

    ip daddr @lan_cidrs return
    ip daddr @local_bypass return
    ip daddr @cn_cidrs return

    meta l4proto tcp tproxy ip to :$tproxy_port meta mark set $fwmark counter
    meta l4proto udp tproxy ip to :$tproxy_port meta mark set $fwmark counter
  }


  chain dns_nat_out {
    type nat hook output priority dstnat; policy accept;

    meta skuid $mihomo_uid return
    meta skuid $dnsmasq_uid return

    udp dport 53 redirect to :53
    tcp dport 53 redirect to :53
  }

  chain output {
    type route hook output priority mangle; policy accept;

    meta skuid $mihomo_uid return
    meta skuid $dnsmasq_uid return
    meta mark $fwmark return

    ip daddr @lan_cidrs return
    ip daddr @local_bypass return
    ip daddr @cn_cidrs return
    udp dport 53 return
    tcp dport 53 return

    meta mark set $fwmark counter 
  }  
}
